<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCF protocol</title>
    <link rel="stylesheet" href="web/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script>
      let selectedId;
      function pullContacts() {
        $.get("/api/contacts", function(data, status){
          if (status !== 'success') {
            return null;
          }
          let contactsElm = document.getElementsByClassName("contacts")[0];
          contactsElm.innerHTML = '';
          const jsonData = JSON.parse(data);
          jsonData.contacts.forEach((contact)=>{
            let newContact = `<button onclick="selectContact('${contact.address}')" id="${contact.address}" class="contact">
              <span class="contact-name">${contact.name}</span>
              <span class="contact-address">${contact.address}</span>
            </button>`;
            contactsElm.innerHTML += newContact;
          })
        });
      }
      function selectContact(id) {
        if (selectedId) {
          document.getElementById(selectedId).classList.remove("selected");
        }
        let elm = document.getElementById(id);
        if (elm && selectedId !== id) {
          elm.classList.add("selected");
          selectedId = id;
        }
        else {
          selectedId = null;
        }
        if (selectedId) {
          document.getElementById("removeBtn").disabled = false;
        }
        else {
          document.getElementById("removeBtn").disabled = true;
        }
      }
      function removeSelected() {
        $.ajax({
          url: '/api/contact',
          type: 'DELETE',
          data: JSON.stringify({'address': selectedId}),
          success: function(response) {
            selectedId = null;
            document.getElementById("removeBtn").disabled = true;
            pullContacts();
          }
        });
      }
      function addContact(){
        let name = document.getElementById("contactNameInput").value;
        let address = document.getElementById("contactAddInput").value;
        if (name && address) {
          if (!address.match(/^0x[0-9a-fA-F]{4}$/)) {
            alert('Invalid address');
            return;
          }
          if (name.length > 25 || name.length < 1) {
            alert('Incorrect name length (Min 1, Max 25 chars)');
            return;
          }
          $.ajax({
            url: '/api/contact',
            type: 'PUT',
            data: JSON.stringify({
              'address': address,
              'name': name,
            }),
            success: function(response) {
              pullContacts();
              document.getElementById("contactNameInput").value = "";
              document.getElementById("contactAddInput").value = "";
            }
          });
        }
      }

      $(document).ready(function(){
        pullContacts();
      });
    </script>
  </head>
  <body>
    <div class="menu">
      <ul>
        <li><a href="/">HOME</a></li>
        <li><a href="/sensors">SENSORS</a></li>
        <li><a href="#" class="underlined">CONTACTS</a></li>
        <li><a href="/config">CONFIG</a></li>
      </ul>
    </div>
    <div class="content">
      <div class="contacts-container">
        <div class="contacts">
        </div>
        <div class="new_contact">
          <p class="info-label">Add contact:</p>
          <div class="contact-info">
            <div>
              <div>
                <span class="info-label-small">NAME</span>
                <input id="contactNameInput" type="text" maxlength="25">
              </div>
              <div>
                <span class="info-label-small">ADDRESS</span>
                <input id="contactAddInput" maxlength="6" type="text">
              </div>
              <button id="addBtn" onclick="addContact()" class="btn">ADD</button>
            </div>
            <button id="removeBtn" disabled onclick="removeSelected()" class="btn">REMOVE SELECTED</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>