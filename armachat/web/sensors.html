<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoRa protocol</title>
    <link rel="stylesheet" href="web/style.css">
    <script>
      let selectedId;
      let sensorsMap = new Map()

      async function pullSensors() {
        const response = await fetch('/api/sensors')
        const { sensors } = await response.json()
        if (sensors){
          sensorsMap = new Map()
          let contactsElm = document.getElementsByClassName("contacts")[0];
          contactsElm.innerHTML = '';
          sensors.forEach((sensor)=>{

            if (!sensorsMap.has(sensor.address)) {
              sensorsMap.set(sensor.address, sensor)
            }

            let newSensor = `<button onclick="selectContact('${sensor.address}')" id="${sensor.address}" class="contact">
              <span class="contact-name">${sensor.name}</span>
              <span class="contact-address">${sensor.address}</span>
            </button>`;
            contactsElm.innerHTML += newSensor;
          })
        }
      }
      function selectContact(id) {
        if (selectedId) {
          document.getElementById(selectedId).classList.remove("selected");
        }
        let elm = document.getElementById(id);
        if (elm && selectedId !== id) {
          elm.classList.add("selected");
          selectedId = id;
        }
        else {
          selectedId = null;
        }
        if (selectedId) {
          document.getElementById("removeBtn").disabled = false;
          document.getElementById("contactNameInput").value = sensorsMap.get(selectedId).name
          document.getElementById("contactAddInput").value = sensorsMap.get(selectedId).address
          document.getElementById("addBtn").innerText = "EDIT";
        }
        else {
          document.getElementById("removeBtn").disabled = true;
          document.getElementById("contactNameInput").value = ""
          document.getElementById("contactAddInput").value = ""
          document.getElementById("addBtn").innerText = "ADD";
        }
      }
      function removeSelected() {
        if (selectedId) {
          const requestOptions = {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({'address': selectedId}),
          };
          fetch('/api/sensor', requestOptions)
            .then(response => {
              if (response.ok) {
                selectedId = null;
                document.getElementById("removeBtn").disabled = true;
                document.getElementById("contactNameInput").value = ""
                document.getElementById("contactAddInput").value = ""
                document.getElementById("addBtn").innerText = "ADD";
                pullSensors();
              }
            })
        }
      }
      function addContact(){
        let name = document.getElementById("contactNameInput").value;
        let address = document.getElementById("contactAddInput").value;
        if (name && address) {
          if (!address.match(/^0x[0-9a-fA-F]{4}$/)) {
            alert('Invalid address. Address must by in a 0xNNNN format. (e.g. 0x1234)');
            return;
          }
          if (name.length > 25 || name.length < 1) {
            alert('Incorrect name length (Min 1, Max 25 chars)');
            return;
          }

          const requestOptions = {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              'address': address,
              'name': name,
            })
          };
          fetch('/api/sensor', requestOptions)
            .then(response => {
              if (response.ok) {
                pullSensors();
                document.getElementById("contactNameInput").value = "";
                document.getElementById("contactAddInput").value = "";
              }
            })
        }
      }

      document.addEventListener("DOMContentLoaded", function(event) {
        pullSensors();
      });
    </script>
  </head>
  <body>
    <div class="menu">
      <ul>
        <li><a href="/">HOME</a></li>
        <li><a href="#" class="underlined">SENSORS</a></li>
        <li><a href="/contacts">CONTACTS</a></li>
        <li><a href="/config">CONFIG</a></li>
      </ul>
    </div>
    <div class="content">
      <div class="contacts-container">
        <div class="contacts">
        </div>
        <div class="new_contact">
          <p class="info-label">Add sensor:</p>
          <div class="contact-info">
            <div>
              <div>
                <span class="info-label-small">NAME</span>
                <input id="contactNameInput" type="text" maxlength="25">
              </div>
              <div>
                <span class="info-label-small">ADDRESS</span>
                <input id="contactAddInput" maxlength="6" type="text">
              </div>
              <button id="addBtn" onclick="addContact()" class="btn">ADD</button>
            </div>
            <button id="removeBtn" disabled onclick="removeSelected()" class="btn">REMOVE SELECTED</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>