<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCF protocol</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script>
      const MAX_MESSAGE_LENGTH = 240; //TODO this will be dependent on the length of header and other bytes added to message
      let WACK = false;
      let scrollToEnd = true;
      //TODO vytvorit new Map na spravy, tam sa budu ukladat, v urcitych intervaloch sa budu pullovat data zo servera a do mapy sa budu pridavat iba nove spravy, tym zamedzim prepisovaniu timestampu spravy.
      //Tato mapa sa bude musiet ukladat do local storage, aby sa pri refreshi stranky neztratili data, zaroven sa bude musiet po refreshi alebo znovu nacitani stranky zvalidovat ci su v nej aktualne data
      //mohlo by stacit nieco take ze v lokalstoragi mam mapu sprav, po nacitani stranky sa pullnu spravy zo serveru a porovnavam ich s tym co je v localstorage.
      //Tie IDcka ktore prisli zo serveru a mam ich ja v lokalstorage si necham, zvysne spravy zmazem. Tie co ostanu mozem zaroven aj updatnut (stav spravy, ACK/NAK)

      let messageList = new Map();

      function isFailed(messageState) {
        return messageState === 'FAILED' || messageState === 'NAK'
      }

      function showStatusIcons(message) {
        return !!(message.my_msg && !isFailed(message.state) && message.msg_type === 'wack_text')
      }

      function getTime(datetime) {
        return `${String(new Date().getHours()).padStart(2, '0')}:${String(new Date().getMinutes()).padStart(2, '0')}`
      }

      function updateMessageList() {
        let messagesElement = document.getElementsByClassName("messages")[0];
        messagesElement.innerHTML = '';

        messageList.forEach((message)=>{
           messagesElement.innerHTML = messagesElement.innerHTML + `
            <div class="message ${message.msg_type === 'sensor' ? 'sns-message' : ''}">
              ${(message.my_msg && isFailed(message.state)) ? `<button class="fail-msg" onclick="resendMessage(${message.id})">
                <img class="fail-icon" src="icons/refresh-arrow.png" >
                <span>Message failed</span>
              </button>` : ''}
              <span class="message__header ${message.my_msg ? 'my-header':''}">
                ${message.from} ‚ü∂ ${message.to}&nbsp;&nbsp;${getTime(message.receivedTime)}
              </span>
              <div class="message__content ${message.msg_type === 'sensor' ? 'sns-content':''} ${message.my_msg ? 'my-content':''} ${message.my_msg && isFailed(message.state) ? 'failed':''}">
                ${message.payload}
              </div>
              ${showStatusIcons(message) ? (message.state === 'ACK' ? '<img class="icon" src="icons/check.png">' :'<img class="icon" src="icons/check_empty.png">') : ''}
            </div>
           `
          })

        if (scrollToEnd) {
          const sendButton = document.getElementById('sendBtn');
          const traceRouteButton = document.getElementById('tracerouteBtn');
          sendButton.disabled = false;
          traceRouteButton.disabled = false;
          messagesElement.scroll({ top: messagesElement.scrollHeight, behavior: 'smooth' });
          scrollToEnd = false;
        }
      }

      function pullNewMessages() {
        $.get("/messages", function(data, status){
          if (status !== 'success') {
            return null;
          }
          const jsonData = JSON.parse(data);
          jsonData.messages.forEach((message)=>{
            if (!messageList.has(message.id)) {
              messageList.set(message.id, {...message, receivedTime: new Date()})
            }
            else {
              const oldMessage = messageList.get(message.id);
              if (oldMessage.state !== message.state) {
                messageList.set(message.id, {...oldMessage, state:message.state})
              }
            }
          })
          updateMessageList();
        });
      }

      $(document).ready(function(){
        pullNewMessages();
        setInterval(pullNewMessages, 5000);
      });

      function handleToggleChange(e) {
          const snsMessages = document.querySelectorAll('.sns-message');
          snsMessages.forEach((message) => {
            if (e.target.checked) {
              message.style.display = 'flex';
            } else {
              message.style.display = 'none';
            }
          })
      }
      function handleSelectChange(e) {
          const addressInput = document.getElementById('addressInput');
          if (e.target.value === 'custom') {
            addressInput.disabled = false;
            addressInput.value = ""
          } else {
            addressInput.disabled = true;
            addressInput.value = e.target.value;
          }
      }
      function toggleWACK(e) {
        WACK = e.target.checked
      }
      function sendMessage() {
        const addressInput = document.getElementById('addressInput');
        const messageInput = document.getElementById('textArea');
        const maxHopInput = document.getElementById('maxHopInput');
        const prioritySelect = document.getElementById('prioritySelect');
        const sendButton = document.getElementById('sendBtn');

        if (!addressInput.value.match(/^0x[0-9a-fA-F]{4}$/)) {
          alert('Invalid address');
          return;
        }

        if(!maxHopInput.value.match(/^[0-9]+$/) || maxHopInput.value < 1 || maxHopInput.value > 255) {
          alert('Invalid max hop value');
          return;
        }

        if (messageInput.value.length > MAX_MESSAGE_LENGTH || messageInput.value.length === 0) {
          alert('Message is too long or empty');
          return;
        }

        const message = {
          'destination': addressInput.value,
          'message': messageInput.value,
          'max_hop': maxHopInput.value,
          'priority': prioritySelect.value,
          'wack': WACK
        }
        sendButton.disabled = true;
        $.post("/send_message", JSON.stringify(message));
        messageInput.value = '';
        scrollToEnd = true;
      }
      function traceRoute() {
        const addressInput = document.getElementById('addressInput');
        const maxHopInput = document.getElementById('maxHopInput');
        const prioritySelect = document.getElementById('prioritySelect');
        const sendButton = document.getElementById('sendBtn');
        const traceRouteButton = document.getElementById('tracerouteBtn');

         if (!addressInput.value.match(/^0x[0-9a-fA-F]{4}$/)) {
          alert('Invalid address');
          return;
        }

        if(!maxHopInput.value.match(/^[0-9]+$/) || maxHopInput.value < 1 || maxHopInput.value > 255) {
          alert('Invalid max hop value');
          return;
        }

        const message = {
          'destination': addressInput.value,
          'max_hop': maxHopInput.value,
          'priority': prioritySelect.value,
        }

        sendButton.disabled = true;
        traceRouteButton.disabled = true;
        $.post("/traceroute", JSON.stringify(message));
        scrollToEnd = true;
      }
      function resendMessage(messageId){
        //TODO resend message with the same id
        //TODO post to /resend_message, for testing purposes server will just set state to ACK for that message (or REBROADCASTED and it will wait for ACK)
        console.log("Resending message with id: ", messageId);
      }
    </script>
  </head>
  <body>
    <div class="menu">
      <ul>
        <li><a href="#" class="underlined">HOME</a></li>
        <li><a href="sensors.html">SENSORS</a></li>
        <li><a href="contacts.html">CONTACTS</a></li>
        <li><a href="config.html">CONFIG</a></li>
      </ul>
    </div>
    <div class="content">
      <div class="toggle">
        <p class="info-label">Show sensor messages</p>
        <label class="switch">
          <input type="checkbox" onchange="handleToggleChange(event)" checked>
          <span class="slider round"></span>
        </label>
      </div>
      <div class="messages">
      </div>
      <div class="new_msg">
        <div class="toggle">
          <p class="info-label">Send message&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Receive ACK:</p>
          <label class="switch">
            <input type="checkbox" onchange="toggleWACK(event)">
            <span class="slider round"></span>
          </label>
        </div>
        <textarea id="textArea" maxlength="240"></textarea>
        <div class="confirm">
          <div>
            <span class="info-label">Max Hop:</span>
            <input id="maxHopInput" type="number" min="1" max="255" value="3">
            <span class="info-label">Priority:</span>
            <select id="prioritySelect">
              <option value="0">Normal</option>
              <option value="1">High</option>
            </select>
          </div>
          <div>
            <span class="info-label">Destination:</span>
            <select onchange="handleSelectChange(event)">
              <option value="custom">Custom</option>
              <option value="0xFFFF">All</option>
              <option value="0xA2DF">John Doe</option>
              <option value="0x0CA7">Frederic</option>
            </select>
            <input id="addressInput" type="text" maxlength="6">
            <button id="sendBtn" class="btn" onclick="sendMessage()">SEND</button>
          </div>
        </div>
        <button id="tracerouteBtn" class="btn" onclick="traceRoute()">TRACEROUTE</button>
      </div>
    </div>
  </body>
</html>